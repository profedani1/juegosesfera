<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lenguaje ‚Ä¢ Framework de Juegos</title>
<style>
  :root{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,monospace;
    color:#e8f8f5
  }
  html,body{height:100%;margin:0;background:#071018;overflow:hidden}
  #container{position:relative;width:100%;height:100%}
  #uiTop{position:absolute;left:12px;top:12px;z-index:60;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.08);
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    color:#fff;
    font-size:14px;
    user-select:none
  }
  .btn:hover{background:rgba(255,255,255,0.1);transform:translateY(-1px)}
  .small{font-size:13px;color:#9fd}
  #preguntaArea{
    position:absolute;
    right:12px;top:12px;
    z-index:70;
    background:rgba(0,0,0,0.45);
    padding:12px;
    border-radius:10px;
    min-width:240px
  }
  #advancedMenu{
    position:absolute;
    left:12px;top:70px;
    z-index:65;
    background:rgba(0,0,0,0.45);
    padding:10px;
    border-radius:10px;
    max-width:280px;
    max-height:60%;
    overflow:auto;
    display:none; /* <-- oculto al inicio */
  }
  #mensajeFinal{
    position:absolute;
    left:50%;top:50%;
    transform:translate(-50%,-50%);
    color:#fff;
    background:rgba(0,0,0,0.85);
    padding:20px;
    border-radius:14px;
    font-size:18px;
    display:none;
    z-index:80;
    text-align:center
  }
  #feedbackBanner{
    position:absolute;
    left:50%;bottom:24px;
    transform:translateX(-50%);
    z-index:75;
    background:rgba(255,255,255,0.08);
    padding:8px 12px;
    border-radius:10px;
    font-weight:600;
    display:none
  }
  #mistakeLog{
    width:320px;display:none;height:100px;
    background:#071018;
    border:1px solid rgba(255,255,255,0.06);
    color:#9fe;
    padding:8px;border-radius:10px
  }
  @media (max-width:720px){
    #preguntaArea{right:12px;top:auto;bottom:12px;min-width:180px}
    #mistakeLog{width:220px}
  }
</style>
</head>
<body>
<div id="container">
  <div id="uiTop">
    <div class="small" style="display:flex;align-items:center;gap:6px">
      <span style="margin-left:10px;color:#f99">Errores: <strong id="mistakeCount">0</strong></span>
      <span style="margin-left:10px" class="small">Modo:
        <select id="modeSelect" class="btn" style="padding:6px 10px">
          <option value="tunnel">T√∫nel</option>
          <option value="orbit">√ìrbita</option>
        </select>
      </span>
      <button id="btnRestart" class="btn">Reiniciar</button>
      <button id="btnPause" class="btn">Pausa</button>
      <button id="btnToggleLog" class="btn">Ver log</button>
      <button id="btnRecovMode" class="btn" style="display:none">Modo recuperaci√≥n</button>
      <button id="btnClearMistakes" class="btn" style="display:none">Limpiar errores</button>
    </div>
  </div>

  <div id="advancedMenu"></div>

  <div id="preguntaArea">
    <div id="preguntaMain" style="font-weight:700"></div>
    <div id="preguntaEstado" class="small"></div>
    <button id="btnToggleMenu" class="btn">Men√∫</button>
    <textarea id="mistakeLog" readonly></textarea>
  </div>

  <div id="mensajeFinal"></div>
  <div id="feedbackBanner"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<!-- Orden importante: storage primero -->
<script src="./core/storage.js"></script>
<script src="./core/questions.js"></script>
<script src="./core/ui.js"></script>
<script src="./core/core.js"></script>

<script>
(function bootstrap() {
  const params = new URLSearchParams(location.search);
  const modeParam = params.get('mode');
  const select = document.getElementById('modeSelect');
  if (modeParam) select.value = modeParam;

  const btnRecov = document.getElementById('btnRecovMode');
  const btnClear = document.getElementById('btnClearMistakes');

  function loadModeAndStart(){
    const modeName = select.value;
    const s = document.createElement('script');
    s.src = `modes/${modeName}.js`;
    s.onload = () => {
      if (typeof UI !== 'undefined')
        UI.buildAdvancedMenu(document.getElementById('advancedMenu'));
      window.GameCore.start(modeName);
    };
    s.onerror = () => alert(`No se pudo cargar el modo: ${modeName}`);
    document.body.appendChild(s);
  }

  // mostrar botones si hay errores guardados
  if (StorageAPI.hasMistakes()) {
    UI.showRecoveryButtons(true);
  }

  document.getElementById('btnRestart').onclick = () => window.GameCore.restart();
  document.getElementById('btnPause').onclick = () => window.GameCore.togglePause();

  document.getElementById('btnToggleMenu').onclick = () => {
    const menu = document.getElementById('advancedMenu');
    menu.style.display = (menu.style.display === 'none' || !menu.style.display) 
      ? 'block' 
      : 'none';
  };

  document.getElementById('btnToggleLog').onclick = () => {
    const ta = document.getElementById('mistakeLog');
    ta.style.display = (ta.style.display === 'none' || !ta.style.display) ? 'block' : 'none';
  };

  btnClear.onclick = () => {
    if(confirm('¬øBorrar todos los errores guardados?')){
      StorageAPI.clearMistakes();
      UI.showRecoveryButtons(false);
    }
  };

  // üî• aqu√≠ ya usamos el m√©todo integrado en GameCore
  btnRecov.onclick = () => {
    window.GameCore.startRecovery();
  };

  select.onchange = () => {
    window.GameCore.stop();
    loadModeAndStart();
    history.replaceState(null, '', `?mode=${select.value}`);
  };

  // Construir men√∫ avanzado (usa el estado ya cargado en QuestionsAPI)
  if(typeof UI !== 'undefined') UI.buildAdvancedMenu(document.getElementById('advancedMenu'));

  loadModeAndStart();
})();
</script>
</body>
</html>
